<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>See</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- CSS 파일 링크 -->
    <link rel="stylesheet" href="styles/general.css">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/contents.css">
    <link rel="stylesheet" href="styles/footer.css">
    <link rel="stylesheet" href="styles/popup.css">
    <!-- Font Awesome 아이콘 라이브러리 -->
    <script src="https://kit.fontawesome.com/44abc8888a.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="home">
    <img class="ad" src="assets/2.jpg">
    <div class="overlay">
        <header class="header">
            <img class="logo" src="assets/logo.png">
            <div class="nav">
                <div class="nav-item" onclick="goToHome()">홈</div>
                <div class="nav-item" onclick="goToMovie()">영화 시리즈 모음 </div>
                <div class="nav-item" onclick="goToContents()">추천 콘텐츠</div>
            </div>
            <div class="menu">
                <div class="search" onclick="goToSearch()">
                    <i class="fa-solid fa-magnifying-glass fa-2x" style="color: #ffffff;"></i>
                </div>
                <img class="profile" src="assets/user.png" onclick="goToProfile()">
            </div>
        </header>
    </div>

    <!-- 배너 영역 -->
    <div class="banner">
        <img class="ad-title" src="assets/main_movie_title.webp">
        <div class="comment">줄거리</div>
        <div class="description">기이한 병이 대물림되는 집안의 장손에게 거액의 의뢰를 받은 무당 화림과 봉길. 조상의 묫자리가 화근임을 알아챈 두 사람은 풍수사 상덕과 장의사 영근에게 도움을 청하지만, 상덕은 불길한 기운을 감지한다.<br></div>
        <div class="buttons">
            <div class="play-button" onclick="playVideo()">
                <i class="fa-solid fa-play" style="color: #000000;"></i>
                재생
            </div>
            <div class="info-button" onclick="infoVideo()">
                <i class="fa-solid fa-circle-info" style="color: #ffffff;"></i>
                상세 정보
            </div>
        </div>
    </div>

    <!-- 카테고리 목록 영역 -->
    <div class="category-list">
        <!-- 시청 중인 콘텐츠 목록 -->
        <div class="category">
            <div class="title" id="user-title"></div>
            <div class="list" id="watching-list"></div>
        </div>

        <div class="category">
            <div class="title">추천 애니 시리즈</div>
            <div class="list" id="recommended-movies-list">
            </div>
        </div>

        <!-- 추천 시리즈 목록 -->
        <div class="category">
            <div class="title">추천 국내영화 시리즈</div>
            <div class="list" id="recommended-kmovies-list"></div>
        </div>

        <!-- 추천 시리즈 목록 -->
        <div class="category">
            <div class="title">추천 해외영화 시리즈</div>
            <div class="list" id="recommended-umovies-list"></div>
        </div>

    </div>
</div>

<!-- 팝업창 -->
<div id="videoPopup" class="popup">
    <span class="close" onclick="closePopup()">&times;</span>
    <div id="movieInfo" style="display: flex; align-items: flex-start;">
        <div class="popup-content">
            <div id="videoText" style="position: relative;">
                <!-- 영화 정보 텍스트 -->
                <h1 style="font-size: 50px; padding-left: 20px;"><span id="movieName"></span></h1>
                <p style="font-size: 15px; padding-left: 20px;">감독 : <span id="movieDirector"></span></p>
                <p style="font-size: 15px; padding-left: 20px; margin-bottom: 50px;">배우 : <span id="movieActors"></span></p>
                <p style="font-size: 18px; padding-left: 25px;">"<span id="movieGenre"></span>"</p>
                <!-- 비디오 플레이어 및 전체 화면 재생 버튼 -->
                <video id="popupVideo" controls style="width: 1%; margin-bottom: 80px;"></video>
                <button class="fullScreenButton" onclick="toggleFullScreen()">▶︎재생</button>
                <button class="fullScreenButton" onclick="writeReview()">★리뷰</button>

            </div>
        </div>
        <img class="logo" src="assets/logo.png" style="margin-top: 20px; margin-left: auto;">
    </div>
</div>




<footer>
    <div class="info">
        <span>See 통신판매업신고번호: 제 9999 전화번호: 9999-9999 (수신자 부담)</span> <br> <br>
        <span>대표: 박정현, 조승연</span> <br> <br>
        <span>이메일 주소: qkrwjdgus1441@naver.com</span> <br><br>
        <span>주소: 대한민국</span> <br><br>
        <span>사업자등록번호: 9999-9999-99</span> <br><br>
    </div>
</footer>

<script>



    // 페이지 로드 시 호출되는 함수
    window.addEventListener('load', displayMoviesAndVideos); // 애니
    window.addEventListener('load', displaykMoviesAndVideos); // 국내
    window.addEventListener('load', displayuMoviesAndVideos); // 해외
    window.addEventListener('load', getSessionIdAndUpdateSessionId); // 세션값

    function getSessionIdAndUpdateSessionId() { // 페이지 로드 시 세션 ID를 서버로부터 받아오는 함수
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var responseData = JSON.parse(this.responseText);
                var sessionId = responseData.session_id;
                // 세션 ID를 받아왔으므로 이를 화면에 표시합니다.
                document.getElementById("user-title").innerText = sessionId + "님이 시청중인 콘텐츠";
                console.log("받은 세션 ID:", sessionId);
                // 여기서 받은 세션 ID를 활용하여 추가 작업을 수행할 수 있습니다.
            }
        };
        xhttp.open("GET", "/sessionid", true);
        xhttp.send();
    }

    function toggleFullScreen() { // 비디오 작게 숨기고 재생버튼 누를시 바로 전체화면
        var videoPlayer = document.getElementById('popupVideo');

        if (!document.fullscreenElement) {
            // 비디오 플레이어가 전체 화면 모드가 아닌 경우 전체 화면으로 변경
            if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen();
            } else if (videoPlayer.mozRequestFullScreen) { /* Firefox */
                videoPlayer.mozRequestFullScreen();
            } else if (videoPlayer.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                videoPlayer.webkitRequestFullscreen();
            } else if (videoPlayer.msRequestFullscreen) { /* IE/Edge */
                videoPlayer.msRequestFullscreen();
            }
        } else {
            // 전체 화면 모드인 경우 전체 화면 종료
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
            }
        }
    }



    // 영화 클릭 시 추천 시리즈 목록 가져오고 보여주는 함수
    function displayMoviesAndVideos() { // 애니
        // AJAX 요청
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var responseData = JSON.parse(this.responseText);

                // 추천 시리즈 목록 표시
                displayRecommendedMovies(responseData.movies);
            }
        };
        xhttp.open("GET", "/movieinfoData", true);
        xhttp.send();
    }

    function displaykMoviesAndVideos() { // 국내
        // AJAX 요청
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var responseData = JSON.parse(this.responseText);

                // 추천 시리즈 목록 표시
                displayRecommendedKMovies(responseData.movies);
            }
        };
        xhttp.open("GET", "/kmovieinfoData", true);
        xhttp.send();
    }


    function displayuMoviesAndVideos() { // 해외
        // AJAX 요청
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var responseData = JSON.parse(this.responseText);

                // 추천 시리즈 목록 표시
                displayRecommendedUMovies(responseData.movies);
            }
        };
        xhttp.open("GET", "/umovieinfoData", true);
        xhttp.send();
    }


    // 추천 시리즈 목록을 화면에 표시하는 함수
    function displayRecommendedMovies(movies) { //애니
        var moviesContainer = document.getElementById('recommended-movies-list');

        movies.forEach((movieData, index) => {
            var movieElement = document.createElement('div');
            movieElement.classList.add('movie');
            movieElement.dataset.moviename = movieData.moviename; // 썸네일에 moviename 데이터 설정

            // Base64 이미지 데이터 디코딩
            var decodedImageData = atob(movieData.thumbnail);
            var decodedDataArray = new Uint8Array(decodedImageData.length);
            for (var i = 0; i < decodedImageData.length; i++) {
                decodedDataArray[i] = decodedImageData.charCodeAt(i);
            }
            var blob = new Blob([decodedDataArray], { type: 'image/jpeg' });

            var movieImage = document.createElement('img');
            movieImage.src = URL.createObjectURL(blob);
            movieImage.classList.add('movie-image'); // 수정된 부분

            // 영화 이름을 표시할 요소 추가
            var movieNameElement = document.createElement('div');
            movieNameElement.classList.add('moviename');
            movieNameElement.textContent = movieData.moviename;



            movieElement.appendChild(movieImage);
            moviesContainer.appendChild(movieElement);
        });
        console.log('추천 애니 시리즈 목록 가져오기 성공.');
    }

    function displayRecommendedKMovies(movies) { // 국내
        var moviesContainer = document.getElementById('recommended-kmovies-list');

        movies.forEach((movieData, index) => {
            var movieElement = document.createElement('div');
            movieElement.classList.add('movie');
            movieElement.dataset.moviename = movieData.moviename; // 썸네일에 moviename 데이터 설정

            // Base64 이미지 데이터 디코딩
            var decodedImageData = atob(movieData.thumbnail);
            var decodedDataArray = new Uint8Array(decodedImageData.length);
            for (var i = 0; i < decodedImageData.length; i++) {
                decodedDataArray[i] = decodedImageData.charCodeAt(i);
            }
            var blob = new Blob([decodedDataArray], { type: 'image/jpeg' });

            var movieImage = document.createElement('img');
            movieImage.src = URL.createObjectURL(blob);
            movieImage.classList.add('kmovie-image'); // 수정된 부분

            // 영화 이름을 표시할 요소 추가
            var movieNameElement = document.createElement('div');
            movieNameElement.classList.add('moviename');
            movieNameElement.textContent = movieData.moviename;

            var movieActorElement = document.createElement(('div'));
            movieActorElement.classList.add('movieactor');
            movieActorElement.textContent = movieData.movie;
            movieElement.appendChild(movieImage);
            moviesContainer.appendChild(movieElement);
        });
        console.log('추천 국내 시리즈 목록 가져오기 성공.');
    }

    function displayRecommendedUMovies(movies) { // 해외
        var moviesContainer = document.getElementById('recommended-umovies-list');

        movies.forEach((movieData, index) => {
            var movieElement = document.createElement('div');
            movieElement.classList.add('movie');
            movieElement.dataset.moviename = movieData.moviename; // 썸네일에 moviename 데이터 설정

            // Base64 이미지 데이터 디코딩
            var decodedImageData = atob(movieData.thumbnail);
            var decodedDataArray = new Uint8Array(decodedImageData.length);
            for (var i = 0; i < decodedImageData.length; i++) {
                decodedDataArray[i] = decodedImageData.charCodeAt(i);
            }
            var blob = new Blob([decodedDataArray], { type: 'image/jpeg' });

            var movieImage = document.createElement('img');
            movieImage.src = URL.createObjectURL(blob);
            movieImage.classList.add('umovie-image'); // 수정된 부분

            // 영화 이름을 표시할 요소 추가
            var movieNameElement = document.createElement('div');
            movieNameElement.classList.add('moviename');
            movieNameElement.textContent = movieData.moviename;

            movieElement.appendChild(movieImage);
            moviesContainer.appendChild(movieElement);
        });
        console.log('추천 해외 시리즈 목록 가져오기 성공.');
    }

    // 영화 썸네일 클릭 이벤트 처리
    document.addEventListener('click', function(event) {
        var target = event.target;
        // 클릭된 요소가 영화 썸네일 이미지인 경우
        if (target.classList.contains('movie-image')) { // 애니
            // 썸네일 이미지의 부모 요소인 movie 클래스를 찾아서 그 요소의 moviename 가져오기
            var movieName = target.closest('.movie').dataset.moviename;

            console.log("클릭된 썸네일의 영화 이름:", movieName);

            // 컨트롤러에 요청 보내기
            requestStreaming(movieName);
        }
        if (target.classList.contains('kmovie-image')) { // 국내
            // 썸네일 이미지의 부모 요소인 movie 클래스를 찾아서 그 요소의 moviename 가져오기
            var movieName = target.closest('.movie').dataset.moviename;

            console.log("클릭된 썸네일의 영화 이름:", movieName);

            // 컨트롤러에 요청 보내기
            krequestStreaming(movieName);
        }
        if (target.classList.contains('umovie-image')) { // 해외
            // 썸네일 이미지의 부모 요소인 movie 클래스를 찾아서 그 요소의 moviename 가져오기
            var movieName = target.closest('.movie').dataset.moviename;

            console.log("클릭된 썸네일의 영화 이름:", movieName);

            // 컨트롤러에 요청 보내기
            urequestStreaming(movieName);
        }
    });



    // 영상 스트리밍 요청 및 클라이언트 측의 시간 업데이트 함수 수정
    function requestStreaming(movieName) { // 애니
        var videoPlayer = document.getElementById('popupVideo');
        videoPlayer.src = '/streamingEndpoint?movieName=' + encodeURIComponent(movieName);
        openPopup(movieName);
    }
    function krequestStreaming(movieName) { // 국내
        var videoPlayer = document.getElementById('popupVideo');
        videoPlayer.src = '/kstreamingEndpoint?movieName=' + encodeURIComponent(movieName);
        openKPopup(movieName);
    }
    function urequestStreaming(movieName) { // 해외
        var videoPlayer = document.getElementById('popupVideo');
        videoPlayer.src = '/ustreamingEndpoint?movieName=' + encodeURIComponent(movieName);
        openUPopup(movieName);
    }


    // AJAX 요청으로 영화 정보를 가져오는 함수
    function getMovieInfoAndDisplay(movieName) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var movieInfo = JSON.parse(this.responseText);
                setMovieInfo(movieInfo);
            }
        };
        xhttp.open("GET", "/movieinfo?movieName=" + encodeURIComponent(movieName), true);
        xhttp.send();
    }

    function getKMovieInfoAndDisplay(movieName) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var movieInfo = JSON.parse(this.responseText);
                setMovieInfo(movieInfo);
            }
        };
        xhttp.open("GET", "/kmovieinfo?movieName=" + encodeURIComponent(movieName), true);
        xhttp.send();
    }

    function getUMovieInfoAndDisplay(movieName) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var movieInfo = JSON.parse(this.responseText);
                setMovieInfo(movieInfo);
            }
        };
        xhttp.open("GET", "/umovieinfo?movieName=" + encodeURIComponent(movieName), true);
        xhttp.send();
    }

    function setMovieInfo(movieInfo) {
        // 영화 정보 설정
        document.getElementById('movieName').textContent = movieInfo.moviename;
        document.getElementById('movieActors').textContent = movieInfo.movieactor;
        document.getElementById('movieDirector').textContent = movieInfo.moviedirector;
        document.getElementById('movieGenre').textContent = movieInfo.moviegenre;
    }


    // 팝업 열기 함수
    function openPopup(movieName) {
        var popup = document.getElementById('videoPopup');
        popup.style.display = 'block'; // 수정된 부분

        getMovieInfoAndDisplay(movieName);
    }

    function openKPopup(movieName) {
        var popup = document.getElementById('videoPopup');
        popup.style.display = 'block'; // 수정된 부분

        getKMovieInfoAndDisplay(movieName);
    }

    function openUPopup(movieName) {
        var popup = document.getElementById('videoPopup');
        popup.style.display = 'block'; // 수정된 부분

        getUMovieInfoAndDisplay(movieName);
    }

    // 팝업 닫기 함수
    function closePopup() { // 팝업 닫을시 영상 중지
        var popup = document.getElementById('videoPopup');
        var videoPlayer = document.getElementById('popupVideo');

        // 동영상 재생 중지
        videoPlayer.pause();

        // 팝업 닫기
        popup.style.display = 'none'; // 수정된 부분
    }


    // 메뉴 클릭 시 동작 함수들
    function goToHome() {
        window.location.href = "index";
    }

    function goToMovie() {
        window.location.href = "movie_list"
    }

    function goToContents() {
        alert("신규컨텐츠로 이동")
    }

    function goToWish() {
        alert("찜목록으로 이동")
    }

    function goToSearch() {
        alert("검색창 이동")
    }

    function goToNotifications() {
        alert("알림창 이동")
    }

    function goToProfile() {
        window.location.href = "login_success";
    }

    // 재생 버튼 클릭 시 동작 함수
    function playVideo() {
        alert("영상재생");
    }

    // 영상 정보 버튼 클릭 시 동작 함수
    function infoVideo() {
        alert("영상 상세정보")
    }
</script>


</body>
</html>
